<!doctype html>
<html lang="it">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Uniss Soil Sample</title>

	<!-- Leaflet -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
	<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

	<<!-- Supabase JS v2 (UMD) -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

	<!-- JSZip per creare KMZ -->
	<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

	<style>
    :root{
      --bg:#ffffff; --ink:#0f172a; --muted:#475569; --line:#e2e8f0; --brand:#2563eb;
      --surface:#f8fafc; --shadow:0 6px 20px rgba(2,6,23,.12);
      --radius:12px;
    }
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }

    .panel {
      position: absolute; top: 12px; left: 12px; z-index: 1000;
      background: var(--bg); padding: 14px; border-radius: var(--radius);
      box-shadow: var(--shadow); font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      width: min(360px, calc(100% - 24px));
      border: 1px solid var(--line);
    }
    .panel h3 {
      margin: 0 0 8px; font-size: 18px; font-weight: 700; color: var(--ink);
    }
    .field { margin-top: 10px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 4px; }
    input[type="text"],
    input:not([type]),
    input[type="search"]{
      width: 100%; padding: 8px 10px; font-size: 14px; color: var(--ink);
      border: 1px solid var(--line); border-radius: 10px; background: var(--surface);
      outline: none;
    }
    input:focus{ border-color: var(--brand); background: #fff; }

    .toggle {
      display: inline-flex; align-items: center; gap: 8px;
      margin-top: 10px; user-select: none;
    }
    .toggle input[type="checkbox"]{
      width: 18px; height: 18px; accent-color: var(--brand); cursor: pointer;
      margin: 0;
    }
    .toggle span{ font-size: 14px; color: var(--ink); }

    .btn {
      width: 100%; padding: 10px 12px; margin-top: 10px;
      border-radius: 10px; border: 1px solid var(--line);
      background: #fff; color: var(--ink); font-size: 14px; cursor: pointer;
    }
    .btn.primary{
      background: var(--brand); color: #fff; border: none;
    }
    .btn:active{ transform: translateY(1px); }

    .actions{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; }

    .note { font-size: 12px; color: var(--muted); margin-top: 6px; line-height: 1.35; }

    .icon-row{
      display:flex; align-items:center; gap:10px; margin-top: 10px;
    }
    .icon-btn{
      display:inline-flex; align-items:center; justify-content:center;
      width: 40px; height: 40px; border-radius: 999px; border: 1px solid var(--line);
      background:#fff; cursor:pointer; box-shadow: var(--shadow);
    }
    .icon-btn svg{ width: 20px; height: 20px; }

    .gps-ok{ color: #059669; }
    .gps-bad{ color: #dc2626; }

    .leaflet-tooltip.name-label {
      background: rgba(255,255,255,.92); color:#111; border:1px solid #ddd;
      font-weight:600; padding:2px 6px; border-radius:6px;
    }

    /* ===== Modal elenco punti ===== */
    .modal-backdrop{
      position: fixed; inset: 0; background: rgba(2,6,23,.45);
      display: none; align-items: center; justify-content: center; z-index: 2000;
    }
    .modal{
      width: min(520px, calc(100% - 24px));
      background: var(--bg); border: 1px solid var(--line); border-radius: 14px;
      box-shadow: var(--shadow); padding: 12px;
      max-height: 70vh; display: flex; flex-direction: column;
    }
    .modal header{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      border-bottom: 1px solid var(--line); padding: 8px 4px; margin-bottom: 8px;
    }
    .modal h4{ margin:0; font-size:16px; color:var(--ink) }
    .modal .close{ background:#fff; border:1px solid var(--line); border-radius:8px; padding:6px 10px; cursor:pointer; }
    .modal .list{
      overflow:auto; padding: 6px 2px; display: grid; gap: 6px;
    }
    .point-item{
      display:grid; grid-template-columns: 1fr auto; gap: 8px; align-items:center;
      border:1px solid var(--line); border-radius:10px; padding:8px 10px; background:var(--surface);
    }
    .point-item .meta{ font-size: 12px; color: var(--muted); }
    .point-item .go{
      padding:6px 10px; border-radius:8px; border:1px solid var(--line);
      background:#fff; cursor:pointer;
    }
    .modal .search{
      margin: 6px 0 10px;
    }
    .modal input[type="search"]{
      width:100%;
      padding:8px 10px; border:1px solid var(--line); border-radius:10px; background:var(--surface);
    }
	/* Toast "Aggiunto" */
.toast {
  position: fixed;
  left: 50%;
  bottom: 16px;
  transform: translateX(-50%) translateY(8px);
  background: #0f172a;
  color: #fff;
  padding: 8px 12px;
  border-radius: 10px;
  box-shadow: 0 6px 20px rgba(2,6,23,.18);
  font: 600 14px/1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  opacity: 0;
  pointer-events: none;
  transition: opacity .18s ease, transform .18s ease;
  z-index: 3000;
}
.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h3>Uniss Soil Sample</h3>

    <div class="field">
      <label for="name">Nome</label>
      <input id="name" placeholder="Es. Punto A" autocomplete="off" />
    </div>
    <div class="field">
      <label for="land_cover">Land cover</label>
      <input id="land_cover" placeholder="Es. Bosco, Pascolo" autocomplete="off" />
    </div>
    
    <div class="field">
      <label for="photoFile">Foto (opzionale)</label>
      <input id="photoFile" type="file" accept="image/*" />
      <div class="hint">E' consentita una foto per punto</div>
    </div>
<div class="row">
      <div class="field">
        <label for="lat">Latitudine</label>
        <input id="lat" placeholder="Es. 40.726" inputmode="decimal" />
      </div>
      <div class="field">
        <label for="lon">Longitudine</label>
        <input id="lon" placeholder="Es. 9.000" inputmode="decimal" />
      </div>
    </div>

    <!-- Sempre spuntato -->
    <label class="toggle">
      <input type="checkbox" id="saveCloud" checked />
      <span>Salva su cloud (Supabase)</span>
    </label>

    <button id="addBtn" class="btn primary">Aggiungi alla mappa</button>

    <div class="actions">
      <button id="exportKmzBtn" class="btn" title="Esporta punti della mappa">Esporta punti</button>
      <button id="clearBtn" class="btn" title="Cancella i punti in locale">Reset locale</button>
    </div>

    <!-- Nuovo: elenco punti -->
    <button id="listBtn" class="btn" title="Mostra l'elenco dei punti caricati da Supabase">Elenco punti</button>

    <div class="icon-row">
      <button id="gpsOnceBtn" class="icon-btn" title="Attiva GPS">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="12" r="3" stroke-width="2"/>
          <path d="M12 2v3M12 19v3M2 12h3M19 12h3" stroke-width="2" stroke-linecap="round"/>
          <circle cx="12" cy="12" r="8" stroke-width="2" />
        </svg>
      </button>
      <p class="note" id="gpsStatus">GPS inattivo</p>
    </div>

    <p class="note"></p>
  </div>

  <!-- Modal elenco punti -->
  <div class="modal-backdrop" id="pointsModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pointsTitle">
      <header>
        <h4 id="pointsTitle">Elenco punti (Supabase)</h4>
        <button class="close" id="closeModalBtn">Chiudi</button>
      </header>
      <div class="search">
        <input id="pointsSearch" type="search" placeholder="Cerca per nome…" />
      </div>
      <div class="list" id="pointsList"></div>
    </div>
  </div>

  <script>
window.addEventListener('load', () => {
  // =========================
  // CONFIG
  // =========================
  const START_VIEW = [40.0, 9.0];
  const START_ZOOM = 8;
  const GEOJSON_URL = 'points.geojson';
  const LS_KEY = 'webgis_user_points_v1';
  const ACCURACY_TABLE = 'accuracy_points';
  const ACC_LABEL_ZOOM = 14;

  // =========================
  // UTILITY
  // =========================
  function escapeHtml(s) {
    return String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  function isValidLatLon(lat, lon) {
    return Number.isFinite(lat) && Number.isFinite(lon) &&
           lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180;
  }

  function buildId(name, lat, lon) {
    return String(lat.toFixed(6)) + ',' + String(lon.toFixed(6)) + '|' + String(name || '').trim().slice(0,80);
  }

  function getAny(obj, keys) {
    if (!obj) return undefined;
    for (const k of keys) {
      if (k in obj && obj[k] != null && obj[k] !== '') return obj[k];
      const low = k.toLowerCase();
      for (const kk of Object.keys(obj)) {
        if (kk.toLowerCase() === low && obj[kk] != null && obj[kk] !== '') return obj[kk];
      }
    }
    return undefined;
  }

  function optRow(label, value) {
    if (value === undefined || value === null || value === '') return '';
    return (label ? (label + ': <b>' + escapeHtml(String(value)) + '</b><br>') : (escapeHtml(String(value)) + '<br>'));
  }

  function showToast(msg) {
    const t = document.getElementById('toast');
    if (!t) return;
    t.textContent = msg || 'Aggiunto';
    t.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => t.classList.remove('show'), 1800);
  }

  // =========================
  // Supabase init (tollerante)
  // =========================
  const SUPABASE_URL = 'https://bvdabdniussqmjjxvrdb.supabase.co';
  const SUPABASE_ANON_KEY =
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ2ZGFiZG5pdXNzcW1qanh2cmRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNjMwMTAsImV4cCI6MjA3NzkzOTAxMH0.pMKdERP0lygqVoYSsEI4eH60BYcXr5QwJNhxf1ZUddM';

  let supabase = null;
  if (window.supabase && typeof window.supabase.createClient === 'function') {
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } catch (e) {
      console.error('Errore creazione client Supabase:', e);
      supabase = null;
    }
  } else {
    console.warn('Supabase SDK non trovata: le funzioni cloud saranno disabilitate.');
  }

  function resolvePhotoUrl(photo_url) {
    const raw = String(photo_url || '').trim();
    if (!raw || !supabase) return '';
    if (/^https?:\/\//i.test(raw)) return raw;
    try {
      const result = supabase.storage.from('soil_photos').getPublicUrl(raw);
      if (result && result.data && result.data.publicUrl) {
        return result.data.publicUrl;
      }
    } catch (e) {
      console.warn('Errore resolvePhotoUrl:', e);
    }
    return '';
  }

  async function resizeAndCompress(file, scale, quality) {
    scale = scale || (1/3);
    quality = quality || 0.85;
    const img = await new Promise((res, rej) => {
      const i = new Image();
      i.onload = () => res(i);
      i.onerror = rej;
      i.src = URL.createObjectURL(file);
    });
    const w = Math.max(1, Math.round(img.naturalWidth * scale));
    const h = Math.max(1, Math.round(img.naturalHeight * scale));
    const canvas = document.createElement('canvas');
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, w, h);
    const blob = await new Promise((res) => canvas.toBlob(res, 'image/jpeg', quality));
    return blob;
  }

  async function uploadPhotoToSupabase(blob, nameHint) {
    if (!supabase) throw new Error('Supabase non inizializzato');
    const storage = supabase.storage.from('soil_photos');
    const ymd = new Date().toISOString().slice(0,10);
    const fname = String(nameHint || 'punto').replace(/[^\w\-]+/g,'_').slice(0,40);
    const key = ymd + '/' + Date.now() + '-' + fname + '.jpg';
    const { error } = await storage.upload(key, blob, { contentType: 'image/jpeg', upsert: true });
    if (error) throw error;
    return key;
  }

  async function insertSupabasePoint(name, lat, lon, land_cover, photo_url) {
    if (!supabase) return false;
    const safeName = String(name || '').slice(0,80);
    const safeLC   = String(land_cover || '').trim();
    const { error } = await supabase
      .from('points')
      .insert([{ name: safeName, lat: lat, lon: lon, land_cover: safeLC, photo_url: photo_url || null }]);
    if (error) {
      console.error('Errore insert Supabase:', error);
      return false;
    }
    return true;
  }

  // =========================
  // MAPPA + LAYER
  // =========================
  if (typeof L === 'undefined') {
    console.error('Leaflet non disponibile');
    alert('Errore: Leaflet non caricato (L undefined).');
    return;
  }

  const map = L.map('map').setView(START_VIEW, START_ZOOM);

  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const esri = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    {
      maxZoom: 19,
      attribution: 'Sources: Esri, Maxar, Earthstar Geographics, and the GIS User Community'
    }
  );

  const opentopo = L.tileLayer(
    'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
    {
      maxZoom: 17,
      attribution: 'Map data: © OpenStreetMap contributors, SRTM | Map style: © OpenTopoMap'
    }
  );

  const cartoLight = L.tileLayer(
    'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
    {
      maxZoom: 20,
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
    }
  );

  const cartoDark = L.tileLayer(
    'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
    {
      maxZoom: 20,
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
    }
  );

  const seedLayer  = L.geoJSON(null, {
    pointToLayer: (feature, latlng) => {
      const marker = L.marker(latlng);
      const props = feature && feature.properties ? feature.properties : {};
      const name = props.name || props.Nome || '';
      if (name) marker.bindTooltip(name, { permanent: true, direction: 'top', offset: [0,-10], className: 'name-label' });
      marker.bindPopup('<pre>' + escapeHtml(JSON.stringify(props, null, 2)) + '</pre>');
      return marker;
    }
  }).addTo(map);

  const localLayer   = L.layerGroup().addTo(map);
  const cloudLayer   = L.layerGroup().addTo(map);
  const gpsLayer     = L.layerGroup().addTo(map);
  const accuracyLayer= L.layerGroup(); // non attivo di default

  const baseLayers = {
    'OSM Standard': osm,
    'Ortofoto Esri': esri,
    'OpenTopoMap': opentopo,
    'Carto Light': cartoLight,
    'Carto Dark': cartoDark
  };

  const overlays = {
    'Seed (GeoJSON)': seedLayer,
    'Punti locali': localLayer,
    'Punti cloud': cloudLayer,
    'GPS': gpsLayer,
    'Punti Legacy': accuracyLayer
  };

  L.control.layers(baseLayers, overlays, { position:'topright', collapsed:false }).addTo(map);

  const cloudIndex = new Map();

  function addLocalPoint(name, lat, lon, save) {
    const marker = L.marker([lat, lon]).addTo(localLayer);
    if (name) marker.bindTooltip(name, { permanent:true, direction:'top', offset:[0,-10], className:'name-label' });
    marker.bindPopup('<b>' + escapeHtml(name || '') + '</b><br>Lat: ' +
      lat.toFixed(6) + '<br>Lon: ' + lon.toFixed(6));
    if (save) {
      let arr;
      try {
        arr = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
      } catch (e) {
        arr = [];
      }
      arr.push({
        type:'Feature',
        geometry:{ type:'Point', coordinates:[lon,lat] },
        properties:{ name: name || '' }
      });
      localStorage.setItem(LS_KEY, JSON.stringify(arr));
    }
  }

  function loadLocalPoints() {
    let arr;
    try {
      arr = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
      if (!Array.isArray(arr)) arr = [];
    } catch (e) {
      console.warn('Errore parse localStorage:', e);
      arr = [];
    }
    arr.forEach(f => {
      if (!f || !f.geometry || !Array.isArray(f.geometry.coordinates)) return;
      const lon = Number(f.geometry.coordinates[0]);
      const lat = Number(f.geometry.coordinates[1]);
      if (!isValidLatLon(lat, lon)) return;
      const name = (f.properties && f.properties.name) ? f.properties.name : '';
      addLocalPoint(name, lat, lon, false);
    });
  }

  function addCloudPoint(name, lat, lon, photo_url) {
    const marker = L.marker([lat, lon]).addTo(cloudLayer);
    if (name) marker.bindTooltip(name, { permanent:true, direction:'top', offset:[0,-10], className:'name-label' });
    const img = resolvePhotoUrl(photo_url);
    const imgHtml = img ? (
      '<div style="margin-top:6px;">' +
      '<img src="' + img + '" alt="foto" style="max-width:220px;max-height:160px;border-radius:8px;display:block;">' +
      '</div>'
    ) : '';
    marker.bindPopup('<b>' + escapeHtml(name || '') + '</b><br>' + imgHtml);
    const id = buildId(name, lat, lon);
    marker.options.customId = id;
    cloudIndex.set(id, { marker, name, lat, lon, photo_url });
  }

  async function loadSupabasePoints() {
    if (!supabase) return;
    let data, error;
    try {
      const resp = await supabase
        .from('points')
        .select('name,lat,lon,photo_url')
        .order('created_at',{ascending:false})
        .limit(5000);
      data = resp.data;
      error = resp.error;
    } catch (e) {
      console.error('Errore loadSupabasePoints:', e);
      return;
    }
    if (error) {
      console.error('Supabase SELECT points:', error);
      return;
    }
    cloudLayer.clearLayers();
    cloudIndex.clear();
    (data || []).forEach(r => {
      const lat = Number(r.lat);
      const lon = Number(r.lon);
      if (!isValidLatLon(lat, lon)) return;
      addCloudPoint(r.name || '', lat, lon, r.photo_url || '');
    });
    if (document.getElementById('pointsModal') &&
        document.getElementById('pointsModal').style.display === 'flex') {
      renderPointsList();
    }
  }

  function addAccuracyPoint(row) {
    const lat = Number(getAny(row, ['Lat','lat','latitude']));
    const lon = Number(getAny(row, ['Lon','lon','lng','long','longitude']));
    if (!isValidLatLon(lat, lon)) return;
    const name   = getAny(row, ['Name','Nuovo','name','nome']) || '';
    const codice = getAny(row, ['CODICE','codice']) || '';
    const gps    = getAny(row, ['GPS','gps']) || '';
    const acc1   = getAny(row, ['Accuratezza 1','accuratezza_1','accuratezza1']) || '';
    const acc2   = getAny(row, ['Accuratezza 2','accuratezza_2','accuratezza2']) || '';
    const degr   = getAny(row, ['Land_Degradation','land_degradation','land_degr']) || '';
    const clc    = getAny(row, ['Land Cover','Land_Cover','landcover']) || '';

    let color = '#3388ff';
    if (clc === '1A') color = '#dc2626';
    else if (clc === '1B') color = '#059669';

    const marker = L.circleMarker([lat, lon], {
      radius: 6,
      weight: 2,
      color: color,
      fillOpacity: 0.7
    }).addTo(accuracyLayer);
    marker.options._labelName = name;

    const htmlParts = [];
    htmlParts.push('<div style="min-width:220px">');
    htmlParts.push('<div><b>' + escapeHtml(name || '') + '</b></div>');
    if (codice) htmlParts.push('<div><small>Codice: ' + escapeHtml(codice) + '</small></div>');
    htmlParts.push('<div style="margin-top:6px; font-size:13px">');
    htmlParts.push(optRow('GPS', gps));
    htmlParts.push(optRow('Accuratezza 1', acc1));
    htmlParts.push(optRow('Accuratezza 2', acc2));
    htmlParts.push(optRow('Land Degradation', degr));
    htmlParts.push(optRow('Land Cover', clc));
    htmlParts.push('Lat: ' + lat.toFixed(6) + ' • Lon: ' + lon.toFixed(6));
    htmlParts.push('</div></div>');
    marker.bindPopup(htmlParts.join(''));
  }

  function updateAccuracyLabels() {
    const show = map.getZoom() >= ACC_LABEL_ZOOM;
    accuracyLayer.eachLayer((lyr) => {
      const nm = (lyr && lyr.options && lyr.options._labelName) ? lyr.options._labelName : '';
      const hasTooltip = !!(lyr && typeof lyr.getTooltip === 'function' && lyr.getTooltip());
      if (show && nm && !hasTooltip) {
        lyr.bindTooltip(nm, { permanent:true, direction:'top', offset:[0,-8], className:'name-label' });
      } else if (!show && hasTooltip) {
        lyr.unbindTooltip();
      }
    });
  }

  async function loadAccuracyPoints() {
    if (!supabase) {
      console.warn('Supabase non inizializzato: punti legacy non caricati.');
      return;
    }
    let data, error;
    try {
      const resp = await supabase
        .from(ACCURACY_TABLE)
        .select('*')
        .limit(20000);
      data = resp.data;
      error = resp.error;
    } catch (e) {
      console.error('Errore loadAccuracyPoints:', e);
      alert('Errore nel leggere la tabella di accuratezza.');
      return;
    }
    if (error) {
      console.error('Supabase SELECT accuracy:', error);
      alert('Errore nel leggere la tabella di accuratezza.');
      return;
    }
    accuracyLayer.clearLayers();
    (data || []).forEach(addAccuracyPoint);
    updateAccuracyLabels();
  }

  let accuracyLoaded = false;
  map.on('overlayadd', (e) => {
    if (e.layer === accuracyLayer && !accuracyLoaded) {
      accuracyLoaded = true;
      loadAccuracyPoints();
    }
    if (e.layer === accuracyLayer) {
      updateAccuracyLabels();
    }
  });
  map.on('zoomend', updateAccuracyLabels);

  // =========================
  // GPS
  // =========================
  function setGpsStatus(text, cls) {
    const el = document.getElementById('gpsStatus');
    if (!el) return;
    el.textContent = text;
    el.classList.remove('gps-ok','gps-bad');
    if (cls) el.classList.add(cls);
  }

  function gpsOnce() {
    if (!navigator.geolocation) {
      setGpsStatus('GPS non supportato dal browser', 'gps-bad');
      return;
    }
    setGpsStatus('GPS: lettura…');
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const acc = pos.coords.accuracy;
        gpsLayer.clearLayers();
        const m = L.marker([lat, lon]).addTo(gpsLayer);
        m.bindPopup('Lat: ' + lat.toFixed(6) +
          '<br>Lon: ' + lon.toFixed(6) +
          '<br>Acc: ±' + Math.round(acc) + ' m');
        if (Number.isFinite(acc)) {
          L.circle([lat, lon], { radius: acc }).addTo(gpsLayer);
        }
        const latInput = document.getElementById('lat');
        const lonInput = document.getElementById('lon');
        if (latInput) latInput.value = lat.toFixed(6);
        if (lonInput) lonInput.value = lon.toFixed(6);
        map.setView([lat, lon], Math.max(map.getZoom(), 15));
        setGpsStatus('GPS ok • ±' + Math.round(acc) + ' m', 'gps-ok');
      },
      (err) => {
        const reasons = {1:'Permesso negato',2:'Posizione non disponibile',3:'Timeout'};
        const msg = reasons[err.code] || err.message;
        setGpsStatus('Errore GPS: ' + msg, 'gps-bad');
      },
      { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
    );
  }

  // =========================
  // KMZ EXPORT
  // =========================
  function buildKmlFromPoints(points) {
    const esc = (s) => escapeHtml(String(s || ''));
    const placemarks = points.map((p) => {
      return (
        '        <Placemark>\n' +
        '          <name>' + esc(p.name || '') + '</name>\n' +
        '          <ExtendedData>\n' +
        '            <Data name="source"><value>' + esc(p.src) + '</value></Data>\n' +
        '          </ExtendedData>\n' +
        '          <Point><coordinates>' + p.lon + ',' + p.lat + ',0</coordinates></Point>\n' +
        '        </Placemark>\n'
      );
    }).join('\n');

    const kml =
'<?xml version="1.0" encoding="UTF-8"?>\n' +
'<kml xmlns="http://www.opengis.net/kml/2.2">\n' +
'  <Document>\n' +
'    <name>UNISS Soil Sample - Punti</name>\n' +
'    <Style id="pt">\n' +
'      <IconStyle>\n' +
'        <scale>1.1</scale>\n' +
'        <Icon><href>http://maps.google.com/mapfiles/kml/paddle/red-circle.png</href></Icon>\n' +
'      </IconStyle>\n' +
'      <LabelStyle><scale>1.0</scale></LabelStyle>\n' +
'    </Style>\n' +
placemarks +
'  </Document>\n' +
'</kml>';
    return kml;
  }

  async function exportAllKMZ() {
    if (typeof JSZip === 'undefined') {
      alert('JSZip non caricato: impossibile creare KMZ.');
      return;
    }
    let local = [];
    try {
      const arr = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
      if (Array.isArray(arr)) {
        local = arr.map((f) => ({
          name: f && f.properties ? (f.properties.name || '') : '',
          lat:  Number(f && f.geometry && f.geometry.coordinates ? f.geometry.coordinates[1] : NaN),
          lon:  Number(f && f.geometry && f.geometry.coordinates ? f.geometry.coordinates[0] : NaN),
          src:  'local'
        })).filter((p) => isValidLatLon(p.lat, p.lon));
      }
    } catch (e) {
      console.warn('Errore lettura localStorage per export:', e);
    }

    let cloud = [];
    if (supabase) {
      try {
        const resp = await supabase
          .from('points')
          .select('name,lat,lon,photo_url')
          .order('created_at',{ascending:false})
          .limit(5000);
        if (!resp.error && Array.isArray(resp.data)) {
          cloud = resp.data.map((r) => ({
            name: r && r.name ? r.name : '',
            lat: Number(r && r.lat),
            lon: Number(r && r.lon),
            src: 'cloud'
          })).filter((p) => isValidLatLon(p.lat, p.lon));
        }
      } catch (e) {
        console.warn('Errore lettura cloud per export:', e);
      }
    }

    const all = local.concat(cloud);
    if (!all.length) {
      alert('Nessun punto da esportare.');
      return;
    }

    const kml = buildKmlFromPoints(all);
    const zip = new JSZip();
    zip.file('doc.kml', kml);
    const blob = await zip.generateAsync({ type: 'blob' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'points.kmz';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // =========================
  // MODAL ELENCO PUNTI
  // =========================
  const pointsModal = document.getElementById('pointsModal');
  const pointsList  = document.getElementById('pointsList');
  const pointsSearch= document.getElementById('pointsSearch');

  function renderPointsList() {
    if (!pointsList) return;
    const items = Array.from(cloudIndex.values()).map((rec) => ({
      id: rec.marker.options.customId,
      name: rec.name || '',
      lat: Number(rec.lat),
      lon: Number(rec.lon),
      photo_url: rec.photo_url || ''
    }));
    const q = (pointsSearch && pointsSearch.value ? pointsSearch.value : '').toLowerCase().trim();
    const filt = q ? items.filter((it) => it.name.toLowerCase().includes(q)) : items;
    if (!filt.length) {
      pointsList.innerHTML = '<div class="note" style="padding:6px 2px;">Nessun punto da mostrare.</div>';
      return;
    }
    const htmlParts = [];
    filt.forEach((it) => {
      const imgUrl = it.photo_url ? resolvePhotoUrl(it.photo_url) : '';
      htmlParts.push(
        '<div class="point-item">' +
          '<div>' +
            '<div><strong>' + escapeHtml(it.name || "(senza nome)") + '</strong></div>' +
            '<div class="meta">Lat: ' + it.lat.toFixed(6) + ' • Lon: ' + it.lon.toFixed(6) + '</div>' +
            (imgUrl ? '<img src="' + imgUrl + '" alt="foto" style="margin-top:6px;max-width:140px;max-height:100px;border-radius:8px;display:block;">' : '') +
          '</div>' +
          '<button class="go" data-id="' + escapeHtml(it.id) + '" title="Zoom al punto">Vai</button>' +
        '</div>'
      );
    });
    pointsList.innerHTML = htmlParts.join('');
  }

  function openPointsModal() {
    if (!pointsModal) return;
    renderPointsList();
    pointsModal.style.display = 'flex';
    if (pointsSearch) {
      pointsSearch.value = '';
      pointsSearch.focus();
    }
  }

  function closePointsModal() {
    if (!pointsModal) return;
    pointsModal.style.display = 'none';
  }

  function zoomToPointById(id) {
    const rec = cloudIndex.get(id);
    if (!rec) return;
    const lat = rec.lat;
    const lon = rec.lon;
    const marker = rec.marker;
    map.setView([lat, lon], Math.max(map.getZoom(), 17), { animate:true });
    if (marker && typeof marker.openPopup === 'function') {
      if (marker.getPopup()) marker.openPopup();
      else marker.bindPopup('Lat: ' + lat.toFixed(6) + '<br>Lon: ' + lon.toFixed(6)).openPopup();
    }
  }

  // =========================
  // EVENTI UI
  // =========================
  const addBtn = document.getElementById('addBtn');
  const exportKmzBtn = document.getElementById('exportKmzBtn');
  const clearBtn = document.getElementById('clearBtn');
  const gpsOnceBtn = document.getElementById('gpsOnceBtn');
  const listBtn = document.getElementById('listBtn');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const latInput = document.getElementById('lat');
  const lonInput = document.getElementById('lon');
  const landCoverInput = document.getElementById('land_cover');
  const nameInput = document.getElementById('name');
  const saveCloudInput = document.getElementById('saveCloud');
  const photoInput = document.getElementById('photoFile');

  if (addBtn) {
    addBtn.addEventListener('click', async () => {
      const name = nameInput ? nameInput.value.trim() : '';
      const land_cover = landCoverInput ? String(landCoverInput.value || '').trim() : '';
      const lat = latInput ? parseFloat(latInput.value.replace(',', '.')) : NaN;
      const lon = lonInput ? parseFloat(lonInput.value.replace(',', '.')) : NaN;
      const saveCloud = saveCloudInput ? !!saveCloudInput.checked : false;

      if (!isValidLatLon(lat, lon)) {
        alert('Lat/Lon non validi. Esempio lat 40.726, lon 9.000');
        return;
      }

      if (saveCloud && supabase) {
        let photoPath = null;
        const file = (photoInput && photoInput.files && photoInput.files[0]) ? photoInput.files[0] : null;
        if (file) {
          try {
            const resized = await resizeAndCompress(file, 1/3, 0.85);
            photoPath = await uploadPhotoToSupabase(resized, name || 'punto');
          } catch (e) {
            console.warn('Upload foto fallito:', e);
          }
        }
        const ok = await insertSupabasePoint(name, lat, lon, land_cover, photoPath);
        if (!ok) {
          alert('Errore salvataggio su cloud');
        } else {
          await loadSupabasePoints();
          showToast('Aggiunto ✓ (cloud)');
        }
      } else if (saveCloud && !supabase) {
        alert('Supabase non inizializzato: impossibile salvare su cloud.');
        addLocalPoint(name, lat, lon, true);
        showToast('Aggiunto ✓ (solo locale)');
      } else {
        addLocalPoint(name, lat, lon, true);
        showToast('Aggiunto ✓');
      }
    });
  }

  if (exportKmzBtn) {
    exportKmzBtn.addEventListener('click', exportAllKMZ);
  }

  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      if (confirm('Cancellare i punti salvati localmente?')) {
        localStorage.removeItem(LS_KEY);
        localLayer.clearLayers();
      }
    });
  }

  if (gpsOnceBtn) {
    gpsOnceBtn.addEventListener('click', gpsOnce);
  }

  map.on('click', (e) => {
    if (latInput) latInput.value = e.latlng.lat.toFixed(6);
    if (lonInput) lonInput.value = e.latlng.lng.toFixed(6);
  });

  if (listBtn) {
    listBtn.addEventListener('click', openPointsModal);
  }
  if (closeModalBtn) {
    closeModalBtn.addEventListener('click', closePointsModal);
  }
  if (pointsModal) {
    pointsModal.addEventListener('click', (e) => {
      if (e.target === pointsModal) closePointsModal();
    });
  }
  if (pointsSearch) {
    pointsSearch.addEventListener('input', renderPointsList);
  }
  if (pointsList) {
    pointsList.addEventListener('click', (e) => {
      const btn = e.target.closest('button.go');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      zoomToPointById(id);
    });
  }

  // =========================
  // AVVIO
  // =========================
  fetch(GEOJSON_URL)
    .then((r) => { if (!r.ok) throw new Error('GeoJSON non trovato'); return r.json(); })
    .then((j) => { seedLayer.addData(j); })
    .catch(() => {});

  loadLocalPoints();
  loadSupabasePoints();

  console.log('SoilSample inizializzato');
});
</script>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
</body>
</html>
