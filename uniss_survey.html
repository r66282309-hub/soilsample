<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Inserimento punti — solo maschera (fix)</title>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Preconfigurazione Supabase (fornita dall'utente) -->
  <script>
    window.SUPABASE_URL = 'https://bvdabdniussqmjjxvrdb.supabase.co';
    window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ2ZGFiZG5pdXNzcW1qanh2cmRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNjMwMTAsImV4cCI6MjA3NzkzOTAxMH0.pMKdERP0lygqVoYSsEI4eH60BYcXr5QwJNhxf1ZUddM';
    window.DEFAULT_TABLE = 'points';
    window.DEFAULT_BUCKET = 'soil_photos';
  </script>

  <style>
    :root{
      --bg:#ffffff; --ink:#0f172a; --muted:#475569; --line:#e2e8f0; --brand:#2563eb; --surface:#f8fafc;
      --ok:#16a34a; --warn:#b45309; --err:#dc2626;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--ink); font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    .wrap{max-width:780px; margin:40px auto; padding:0 16px}
    h1{margin:0 0 8px; font-size:28px}
    p.lead{margin:0 0 24px; color:var(--muted)}
    .card{background:var(--surface); border:1px solid var(--line); border-radius:16px; padding:18px; box-shadow:0 8px 30px rgba(2,6,23,.06)}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    .row{display:flex; gap:10px}
    .full{grid-column:1/-1}
    label{display:block; font-weight:600; margin-bottom:6px}
    input[type="text"], input[type="number"], select, textarea{
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff;
      outline:none; transition:border-color .15s ease, box-shadow .15s ease;
    }
    input:focus, select:focus, textarea:focus{ border-color: var(--brand); box-shadow: 0 0 0 3px rgba(37,99,235,.12); }
    input[type="file"]{accent-color:var(--brand)}
    .hint{font-size:12px; color:var(--muted); margin-top:6px}
    button{appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:700; cursor:pointer; background:var(--brand); color:#fff; box-shadow:0 6px 16px rgba(37,99,235,.25);}
    button:disabled{opacity:.6; cursor:not-allowed; box-shadow:none}
    .sep{height:1px; background:var(--line); margin:16px 0}
    .toast{position: fixed; left: 50%; bottom: 16px; transform: translateX(-50%) translateY(8px); background:#0f172a; color:#fff; padding:8px 12px; border-radius:10px; box-shadow:0 6px 20px rgba(2,6,23,.18); font:600 14px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; opacity:0; pointer-events:none; transition:opacity .18s ease, transform .18s ease; z-index:3000;}
    .toast.show{opacity:1; transform: translateX(-50%) translateY(0);}
    .mini{font-size:12px; color:var(--muted)}
    .ok{color:var(--ok)} .err{color:var(--err)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Uniss Survey</h1>
    <p class="lead">Versione mobile</p>

    <div class="card">
      <div class="grid">
        <div class="full">
          <label for="name">Nome punto *</label>
          <input id="name" type="text" maxlength="80" placeholder="Es. PF-001" />
          <div class="hint">Max 80 caratteri.</div>
        </div>

        <div>
          <label for="lat">Latitudine *</label>
          <input id="lat" type="number" step="any" inputmode="decimal" placeholder="Es. 40.12345" />
          <a href="#" id="btnGeo" class="mini">Usa geolocalizzazione</a>
        </div>
        <div>
          <label for="lon">Longitudine *</label>
          <input id="lon" type="number" step="any" inputmode="decimal" placeholder="Es. 8.56789" />
        </div>

        <div class="full">
          <label for="landcover">Land cover *</label>
          <select id="landcover">
            <option value="">— seleziona —</option>
            <option value="Bosco">Bosco</option>
            <option value="Rimboschimento">Rimboschimento</option>
            <option value="Macchia">Macchia</option>
            <option value="Pascolo naturale">Pascolo</option>
            <option value="Pascolo arborato">Pascolo arborato</option>
            <option value="altro">Altro…</option>
          </select>
        </div>

        <div class="full">
          <label for="photoFile">Foto </label>
          <input id="photoFile" type="file" accept="image/*" />
          <div class="hint">*.jpg</div>
        </div>

        <div class="full row" style="align-items:center; justify-content:flex-end">
          <button id="btnAdd">Aggiungi punto</button>
        </div>

        <div class="full mini" id="status"></div>
      </div>
    </div>

    <div style="margin-top:16px" class="mini">
      Attendi la conferma di caricamento prima di chiudere.
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // =========================
    // Utilità UI
    // =========================
    const $ = (id)=>document.getElementById(id);
    function showToast(msg){
      const t = $('toast'); if(!t) return; t.textContent = msg || 'Aggiunto';
      t.classList.add('show'); clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> t.classList.remove('show'), 1800);
    }
    function setStatus(msg, cls){ const el=$('status'); el.textContent = msg||''; el.className='full mini ' + (cls||''); }

    // =========================
    // Geolocalizzazione
    // =========================
    document.addEventListener('DOMContentLoaded', ()=>{
      const link = $('btnGeo');
      if (link) {
        link.addEventListener('click', (e)=>{
          e.preventDefault();
          if (!navigator.geolocation) { setStatus('Geolocalizzazione non supportata dal browser', 'err'); return; }
          setStatus('Cerco posizione…');
          navigator.geolocation.getCurrentPosition(pos=>{
            const {latitude, longitude} = pos.coords;
            $('lat').value = latitude.toFixed(6);
            $('lon').value = longitude.toFixed(6);
            setStatus('Posizione ottenuta ✓', 'ok');
          },err=>{
            console.warn('Geo error', err);
            setStatus('Geolocalizzazione negata o fallita', 'err');
          },{enableHighAccuracy:true, timeout:20000, maximumAge:0});
        });
      }
    });

    // =========================
    // Ridimensiona & comprimi immagine
    // =========================
    async function resizeAndCompress(file, scale=1/3, quality=0.85){
      const img = new Image();
      const url = URL.createObjectURL(file);
      await new Promise((res, rej)=>{ img.onload=()=>res(); img.onerror=rej; img.src=url; });
      const w = Math.max(1, Math.round(img.naturalWidth * scale));
      const h = Math.max(1, Math.round(img.naturalHeight * scale));
      const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
      const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
      const blob = await new Promise(res=> canvas.toBlob(res, 'image/jpeg', quality));
      URL.revokeObjectURL(url);
      return new File([blob], (file.name||'photo')+'.jpg', {type:'image/jpeg'});
    }

    // =========================
    // Supabase helpers (sempre attivo)
    // =========================
    function getSupabaseClient(){
      const url = window.SUPABASE_URL;
      const key = window.SUPABASE_ANON_KEY;
      if(!url || !key) throw new Error('Parametri Supabase mancanti');
      return supabase.createClient(url, key);
    }

    async function uploadPhotoToSupabase(file, baseName){
      const sb = getSupabaseClient();
      const bucket = window.DEFAULT_BUCKET || 'soil_photos';
      const ts = new Date().toISOString().replace(/[:.]/g,'');
      const safe = String(baseName||'pt').replace(/[^a-z0-9-_]+/gi,'_').slice(0,40);
      const path = `${safe}_${ts}.jpg`;
      const { error } = await sb.storage.from(bucket).upload(path, file, {contentType:'image/jpeg', upsert:false});
      if(error) throw error;
      const { data } = sb.storage.from(bucket).getPublicUrl(path);
      return data.publicUrl;
    }

    async function insertSupabasePoint(name, lat, lon, land_cover, photo_url){
      const sb = getSupabaseClient();
      const table = window.DEFAULT_TABLE || 'points';
      const safeName = (name||'').slice(0,80);
      const safeLC   = String(land_cover ?? '').trim();
      const { error } = await sb.from(table).insert([{ 
        name: safeName, lat: Number(lat), lon: Number(lon), land_cover: safeLC, photo_url: photo_url || null 
      }]);
      if(error) throw error; 
      return true;
    }

    // =========================
    // Aggiungi punto (locale + cloud always-on)
    // =========================
    const localPoints = [];
    document.addEventListener('DOMContentLoaded', ()=>{
      $('btnAdd').addEventListener('click', async ()=>{
        setStatus('');
        const name = $('name').value.trim();
        const lat = Number(String($('lat').value).replace(',', '.'));
        const lon = Number(String($('lon').value).replace(',', '.'));
        const land = $('landcover').value;
        if(!name){ setStatus('Nome obbligatorio', 'err'); $('name').focus(); return; }
        if(!(Number.isFinite(lat) && lat>=-90 && lat<=90)){ setStatus('Latitudine non valida (-90..90)', 'err'); $('lat').focus(); return; }
        if(!(Number.isFinite(lon) && lon>=-180 && lon<=180)){ setStatus('Longitudine non valida (-180..180)', 'err'); $('lon').focus(); return; }

        // aggiungi localmente
        localPoints.push({name, lat, lon, land_cover: land||'', created_at:new Date().toISOString()});

        // upload foto opzionale + insert cloud
        let photoUrl = null;
        const file = $('photoFile').files[0] || null;
        try{
          if(file){
            const resized = await resizeAndCompress(file, 1/3, 0.85);
            photoUrl = await uploadPhotoToSupabase(resized, name);
          }
          await insertSupabasePoint(name, lat, lon, land, photoUrl);
          showToast('Aggiunto ✓');
          setStatus('Punto salvato corretamente', 'ok');
        }catch(e){
          console.warn(e);
          showToast('Errore cloud');
          setStatus('Errore salvataggio cloud: ' + (e.message||e.name||e), 'err');
        }

        // reset file
        $('photoFile').value = '';
      });
    });
  </script>
</body>
</html>
